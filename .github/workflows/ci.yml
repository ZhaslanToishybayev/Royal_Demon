name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: [ 25 ]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v3

    - name: Compile Java code
      run: ./gradlew compileJava --no-daemon

    - name: Run Checkstyle
      run: ./gradlew checkstyleMain --no-daemon
      continue-on-error: true

    - name: Run SpotBugs
      run: ./gradlew spotbugsMain --no-daemon
      continue-on-error: true

    - name: Run unit tests
      run: ./gradlew test --no-daemon
      continue-on-error: true

    - name: Generate test report
      run: ./gradlew test --no-daemon
      if: always()

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Test-Results-Java-${{ matrix.java-version }}
        path: |
          build/reports/tests/test/
          build/test-results/test/

    - name: Build JAR file
      run: ./gradlew build -x test --no-daemon
      continue-on-error: true

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Build-Artifacts-Java-${{ matrix.java-version }}
        path: build/libs/

    - name: Comment PR with results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const { data: checks } = await github.rest.checks.listForRef({
            ...context.repo,
            ref: context.payload.pull_request.head.sha
          });

          let comment = '## ðŸ“Š CI Pipeline Results\n\n';
          comment += `âœ… **Compilation**: Success\n`;

          const checkstyleCheck = checks.check_runs.find(c => c.name.includes('checkstyle'));
          const spotbugsCheck = checks.check_runs.find(c => c.name.includes('spotbugs'));
          const testCheck = checks.check_runs.find(c => c.name.includes('test'));

          if (checkstyleCheck) {
            comment += `${checkstyleCheck.conclusion === 'success' ? 'âœ…' : 'âš ï¸'} **Checkstyle**: ${checkstyleCheck.conclusion}\n`;
          }

          if (spotbugsCheck) {
            comment += `${spotbugsCheck.conclusion === 'success' ? 'âœ…' : 'âš ï¸'} **SpotBugs**: ${spotbugsCheck.conclusion}\n`;
          }

          if (testCheck) {
            comment += `${testCheck.conclusion === 'success' ? 'âœ…' : 'âš ï¸'} **Tests**: ${testCheck.conclusion}\n`;
          }

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  code-quality:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Run detailed analysis
      run: |
        ./gradlew check --no-daemon || true

    - name: Generate quality report
      run: |
        echo "## ðŸ“ˆ Code Quality Report" > quality-report.md
        echo "" >> quality-report.md
        echo "- **Lines of Code**: $(find src -name '*.java' -exec wc -l {} + | tail -n1 | awk '{print $1}')" >> quality-report.md
        echo "- **Java Files**: $(find src -name '*.java' | wc -l)" >> quality-report.md
        echo "- **Packages**: $(find src -name 'package-info.java' | wc -l)" >> quality-report.md
        echo "" >> quality-report.md
        echo "### Files Analyzed:" >> quality-report.md
        echo "\`\`\`" >> quality-report.md
        find src/main/java -name '*.java' | sort >> quality-report.md
        echo "\`\`\`" >> quality-report.md

    - name: Upload quality report
      uses: actions/upload-artifact@v4
      with:
        name: Quality-Report
        path: quality-report.md

  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run dependency check
      run: |
        echo "Running security scan..."
        # TODO: Add OWASP Dependency Check if needed
        echo "âœ… Security scan completed"

    - name: Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Security-Scan
        path: |
          build/reports/
